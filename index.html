<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>谢战</title>

<style>
@font-face {
  font-family: "PF";
  src: url("./pf.ttf") format("truetype");
}

body {
  background:#f2f3f5;
  font-family: PF, sans-serif;
  margin: 0;
  padding: 0;
}

#box {
  width: 780px;
  margin: 20px auto 40px;
}

.panel {
  background:#fff;
  border-radius: 10px;
  padding: 20px 24px;
  box-shadow: 0 6px 16px rgba(0,0,0,.08);
  margin-bottom: 18px;
}

.panel h2 {
  margin: 0 0 20px;
  font-size: 18px;
  color: #333;
  border-left: 4px solid #1677ff;
  padding-left: 12px;
}

/* ===== 核心布局：每行一个项目 ===== */
.row {
  display: flex;
  align-items: center;
  margin-bottom: 12px;
}

.row label {
  width: 80px; /* 固定标题宽度，确保输入框对齐 */
  font-size: 15px;
  color: #555;
  flex-shrink: 0;
}

input, select {
  flex: 1; /* 自动撑满剩余空间 */
  padding: 8px 12px;
  border: 1px solid #dcdfe6;
  border-radius: 6px;
  font-family: PF;
  font-size: 15px;
  outline: none;
  transition: border-color 0.2s;
}

input:focus {
  border-color: #1677ff;
}

/* 赋分行的特殊处理：让数字框和下拉框并排 */
.row .input-group {
  display: flex;
  flex: 1;
  gap: 8px;
}

.row select {
  flex: 0 0 80px; /* 下拉框固定宽度 */
}

button {
  padding: 10px 20px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-family: PF;
  background:#1677ff;
  color:#fff;
  font-size: 15px;
  margin-top: 8px;
  width: 100%; /* 默认移动端友好，手机端全宽 */
}

#previewBtn {
  background: #52c41a;
  margin-bottom: 10px;
}

.tip {
  margin-top: 12px;
  font-size: 13px;
  color: #888;
  line-height: 1.6;
  text-align: center;
}

/* ===== 画布 ===== */
canvas {
  display:block;
  margin: 20px auto;
  box-shadow: 0 0 14px rgba(0,0,0,.18);
  max-width: 100%;
  height: auto;
}

/* ===== 手机端适配 ===== */
@media (max-width: 768px) {
  #box {
    width: 95%;
    margin: 10px auto;
  }

  .row label {
    width: 70px;
    font-size: 14px;
  }

  canvas {
    display: none; /* 手机端默认不显示 */
  }
}
</style>
</head>

<body>

<div id="box">

  <div class="panel">
    <h2>成绩填写</h2>

    <div class="row">
      <label>时间</label>
      <input id="time">
    </div>

    <div class="row"><label>语文</label><input id="cn" value="150"></div>
    <div class="row"><label>数学</label><input id="math" value="150"></div>
    <div class="row"><label>英语</label><input id="en" value="150"></div>
    <div class="row"><label>物理</label><input id="phy" value="100"></div>
    <div class="row"><label>化学</label><input id="chem" value="100"></div>
    <div class="row"><label>生物</label><input id="bio" value="100"></div>

    <div class="row">
      <label>化学赋分</label>
      <div class="input-group">
        <input id="chemF" value="99">
        <select id="chemLv">
          <option selected>A</option><option>B</option>
          <option>C</option><option>D</option><option>E</option>
        </select>
      </div>
    </div>

    <div class="row">
      <label>生物赋分</label>
      <div class="input-group">
        <input id="bioF" value="99">
        <select id="bioLv">
          <option selected>A</option><option>B</option>
          <option>C</option><option>D</option><option>E</option>
        </select>
      </div>
    </div>

    <div class="row" style="flex-direction: column; margin-top:12px;">
      <button id="previewBtn" onclick="preview()">预览图片内容</button>
      <button id="downloadBtn">生成下载页面 (长按保存)</button>
      <div class="tip">
        <b>操作提示：</b><br>
        修改分数后点击“预览”，确认无误后点击“生成下载页面”，在新标签页中长按图片即可保存。
      </div>
    </div>
  </div>

  <canvas id="cv"></canvas>

</div>

<script>
/* ===== 尺寸参数 ===== */
const LOGICAL_W = 750;
const LOGICAL_H = 1624;
const REAL_W = 1170;
const REAL_H = 2532;
const SCALE = REAL_W / LOGICAL_W;

const cv = document.getElementById('cv');
const ctx = cv.getContext('2d');

cv.width = REAL_W;
cv.height = REAL_H;
cv.style.width = LOGICAL_W + 'px';
cv.style.height = LOGICAL_H + 'px';
ctx.setTransform(SCALE,0,0,SCALE,0,0);

const bg = new Image();
bg.src = 'bakgd.jpg';

/* ===== 自动时间 ===== */
document.getElementById('time').value = new Date().toTimeString().slice(0,5);

document.fonts.ready.then(()=>bg.onload=draw);

function sum(...ids){
  return ids.reduce((s,id)=>s+(+document.getElementById(id).value||0),0);
}

function txt(t,x,y,s=34,c='#000',b=false,a='center'){
  ctx.fillStyle=c;
  ctx.textBaseline='middle';
  ctx.font=`${b?600:400} ${s}px PF`;

  if(/^[0-9.]+$/.test(t)){
    const ref='0000.0';
    let dx=x-ctx.measureText(ref).width/2;
    ctx.textAlign='left';
    for(let i=0;i<t.length;i++){
      const ch=t[i],p=t[i-1];
      let k=(ch==='1'||p==='1')?-3:0;
      ctx.fillText(ch,dx+k,y);
      dx+=ctx.measureText(ch).width+k;
    }
  }else{
    ctx.textAlign=a;
    ctx.fillText(t,x,y);
  }
}

function draw(){
  ctx.clearRect(0,0,LOGICAL_W,LOGICAL_H);
  ctx.drawImage(bg,0,0,LOGICAL_W,LOGICAL_H);

  const raw   = String(sum('cn','math','en','phy','chem','bio'));
  const total = String(sum('cn','math','en','phy','chemF','bioF'));

  // 注意：此处直接使用 ID 获取元素在部分浏览器可能失效，改用 getElementById 获取值
  const timeVal = document.getElementById('time').value;
  const cnVal = document.getElementById('cn').value;
  const mathVal = document.getElementById('math').value;
  const enVal = document.getElementById('en').value;
  const phyVal = document.getElementById('phy').value;
  const chemVal = document.getElementById('chem').value;
  const bioVal = document.getElementById('bio').value;
  const chemFVal = document.getElementById('chemF').value;
  const chemLvVal = document.getElementById('chemLv').value;
  const bioFVal = document.getElementById('bioF').value;
  const bioLvVal = document.getElementById('bioLv').value;

  txt(timeVal,60,45,30,'#000',true,'left');
  txt(total,123,369,39,'#fff',true);
  txt(raw,349,369,39,'#fff',true);

  txt(cnVal,118,570,36,'#000',true);
  txt(mathVal,345,570,36,'#000',true);
  txt(enVal,572,570,36,'#000',true);

  txt(phyVal,118,763,36,'#000',true);
  txt(chemVal,572,763,36,'#000',true);
  txt(bioVal,345,956,36,'#000',true);

  txt(chemFVal,345,763,36,'#000',true,'right');
  txt(chemLvVal,363,763,36,'#000',true,'left');

  txt(bioFVal,118,956,36,'#000',true,'right');
  txt(bioLvVal,136,956,36,'#000',true,'left');
}

/* ===== 预览（显示画布） ===== */
function preview(){
  draw();
  cv.style.display = 'block';
}

/* ===== 下载逻辑：在新标签页打开图片 ===== */
document.getElementById('downloadBtn').onclick = function() {
    draw(); // 确保生成的是最新内容
    const dataURL = cv.toDataURL("image/png");
    const newWindow = window.open();
    if (newWindow) {
        newWindow.document.write(`
            <html>
                <head>
                    <title>长按保存图片</title>
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <style>
                        body { margin: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; background: #333; color: #fff; font-family: sans-serif; }
                        img { max-width: 90%; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
                        p { margin-top: 20px; font-size: 14px; color: #bbb; }
                    </style>
                </head>
                <body>
                    <img src="${dataURL}" />
                    <p>↑ 长按上方图片保存到相册 ↑</p>
                </body>
            </html>
        `);
        newWindow.document.close();
    } else {
        alert("新页面被拦截，请允许弹出窗口权限。");
    }
};
</script>

</body>
</html>